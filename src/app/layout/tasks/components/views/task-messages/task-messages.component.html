<div class="tasks-view tasks-view--messages" [class.dark-theme]="isDarkTheme">
  <app-task-header [projectTitle]="projectTitle"></app-task-header>

  <div class="messages-container" [class.dark-theme]="isDarkTheme">
    <!-- Header -->
    <div class="messages-header">
      <h2 class="messages-title">Messages</h2>
      <div class="header-actions">
        <!-- Future: Add new message button if needed -->
      </div>
    </div>

    <!-- Messages Scroll Area -->
    <div class="messages-scroll" #messagesContainer>
      <!-- Loading / Error -->
      <div class="messages-state" *ngIf="loading || error">
        <mat-spinner diameter="40" *ngIf="loading"></mat-spinner>
        <div class="error-state" *ngIf="error">
          <mat-icon>error_outline</mat-icon>
          <p>{{ error }}</p>
          <button mat-stroked-button (click)="loadMessages()">Retry</button>
        </div>
      </div>

      <!-- Pinned Messages -->
      <app-pinned-messages
        *ngIf="pinnedMessages.length > 0 && !loading"
        [messages]="pinnedMessages"
        [editingMessageId]="editingMessageId"
        [editingContent]="editingContent"
        [canEdit]="canEditMessage.bind(this)"
        [canDelete]="canDeleteMessage.bind(this)"
        [canPin]="canPinMessage"
        [isDarkTheme]="isDarkTheme"
        (edit)="startEditing($event)"
        (saveEdit)="saveEdit($event.messageId, $event.content)"
        (cancelEdit)="cancelEditing()"
        (delete)="deleteMessage($event)"
        (togglePin)="togglePin($event)"
      ></app-pinned-messages>

      <!-- Regular Messages -->
      <div class="regular-messages" *ngIf="regularMessages.length > 0 && !loading">
        <app-message-item
          *ngFor="let message of regularMessages; trackBy: trackByMessageId"
          [message]="message"
          [isPinned]="false"
          [isEditing]="editingMessageId === message.id"
          [editingContent]="editingContent"
          [canEdit]="canEditMessage(message)"
          [canDelete]="canDeleteMessage(message)"
          [canPin]="canPinMessage"
          [isDarkTheme]="isDarkTheme"
          (edit)="startEditing($event)"
          (saveEdit)="saveEdit(message.id)"
          (cancelEdit)="cancelEditing()"
          (delete)="deleteMessage($event)"
          (togglePin)="togglePin($event)"
        ></app-message-item>
      </div>

      <!-- Empty State -->
      <app-messages-empty-state *ngIf="isEmptyState" [isDarkTheme]="isDarkTheme"></app-messages-empty-state>
    </div>

    <!-- Composer -->
    <app-message-composer
      [content]="newMessageContent"
      [sending]="sending"
      [isDarkTheme]="isDarkTheme"
      [showCharacterCount]="showCharacterCount"
      [characterCount]="characterCount"
      (contentChange)="onContentChange($event)"
      (send)="sendMessage()"
      (insertMarkdown)="onInsertMarkdown($event.before, $event.after)"
    ></app-message-composer>
  </div>
</div>
