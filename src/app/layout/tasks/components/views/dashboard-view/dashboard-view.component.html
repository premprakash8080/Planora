<div class="tasks-view tasks-view--dashboard">
  <app-task-header [projectTitle]="projectTitle"></app-task-header>

  <div class="dashboard-toolbar">
    <button mat-flat-button color="primary">
      <mat-icon>add</mat-icon>
      Add widget
    </button>
    <button class="feedback-link" type="button">
      Send feedback
      <mat-icon>north_east</mat-icon>
    </button>
  </div>

  <ng-container *ngIf="!loading && !error; else dashboardState">
    <div class="dashboard-content" *ngIf="charts; else emptyState">
      <section class="stats-grid">
        <button
          type="button"
          class="stat-card"
          *ngFor="let card of statCards; trackBy: trackById"
          (click)="onCardClick(card)"
        >
          <div class="stat-title">{{ card.title }}</div>
          <div class="stat-value">{{ card.value }}</div>
          <div class="stat-helper">{{ card.helperText }}</div>
        </button>
      </section>

      <section class="widget-grid">
        <article class="widget" aria-label="Total incomplete tasks by section">
          <header class="widget-header">
            <div>
              <h3>Total incomplete tasks by section</h3>
              <div class="filter-pill">2 Filters</div>
            </div>
            <button mat-stroked-button color="primary" (click)="onSeeAll('sections')">See all</button>
          </header>
          <div class="widget-body bar-chart">
            <div class="bar-row" *ngFor="let row of charts?.incompleteBySection?.data">
              <div class="bar-label">{{ row.label }}</div>
              <div class="bar-track">
                <div class="bar-fill" [style.width.%]="getSectionBarWidth(row.value)"></div>
                <span class="bar-value">{{ row.value }}</span>
              </div>
            </div>
          </div>
        </article>

        <article class="widget" aria-label="Total tasks by completion status">
          <header class="widget-header">
            <div>
              <h3>Total tasks by completion status</h3>
              <div class="filter-pill">1 Filter</div>
            </div>
            <button mat-stroked-button color="primary" (click)="onSeeAll('completion-status')">See all</button>
          </header>
          <div class="widget-body donut-chart">
            <div class="donut-figure" [style.background]="donutStyle">
              <div class="donut-center">
                <div class="donut-value">{{ completionTotal }}</div>
                <div class="donut-label">Total</div>
              </div>
            </div>
            <ul class="donut-legend">
              <li *ngFor="let segment of charts?.completionStatus?.data">
                <span class="legend-dot" [style.background]="segment.color"></span>
                <span class="legend-label">{{ segment.label }}</span>
                <span class="legend-value">{{ segment.value }}</span>
              </li>
            </ul>
          </div>
        </article>

        <article class="widget" aria-label="Total upcoming tasks by assignee">
          <header class="widget-header">
            <div>
              <h3>Total upcoming tasks by assignee</h3>
              <div class="filter-pill">2 Filters</div>
            </div>
          </header>
          <div class="widget-body assignee-chart" *ngIf="charts?.upcomingByAssignee?.data?.length; else noUpcoming">
            <div class="assignee-column" *ngFor="let person of charts?.upcomingByAssignee?.data">
              <div class="assignee-stack">
                <span class="assignee-dot" *ngFor="let _ of getDots(person.count)" [style.background]="person.color"></span>
                <span class="assignee-more" *ngIf="getRemainingDots(person.count)">+{{ getRemainingDots(person.count) }}</span>
              </div>
              <div class="assignee-meta">
                <div class="assignee-initials" [style.background]="person.color">{{ person.initials }}</div>
                <div class="assignee-name">{{ person.name }}</div>
                <div class="assignee-count">{{ person.count }} tasks</div>
              </div>
            </div>
          </div>
        </article>

        <article class="widget" aria-label="Task completion over time">
          <header class="widget-header">
            <div>
              <h3>Task completion over time</h3>
              <div class="filter-pill">No Filters</div>
            </div>
            <button mat-stroked-button color="primary" (click)="onSeeAll('timeline')">See all</button>
          </header>
          <div class="widget-body area-chart" *ngIf="charts?.completionTrend?.data?.data?.length; else noTrend">
            <svg
              [attr.viewBox]="completionTrendGraph.viewBox"
              preserveAspectRatio="none"
            >
              <path class="area" [attr.d]="completionTrendGraph.areaPath"></path>
              <path class="line" [attr.d]="completionTrendGraph.linePath"></path>
            </svg>
            <div class="timeline-meta">
              <span>{{ completionTrendRangeStart }}</span>
              <span>{{ completionTrendRangeEnd }}</span>
            </div>
            <div class="area-legend">
              <span>
                <span class="legend-swatch total"></span>
                Total
              </span>
              <span>
                <span class="legend-swatch completed"></span>
                Completed
              </span>
            </div>
          </div>
        </article>
      </section>
    </div>
  </ng-container>

  <ng-template #dashboardState>
    <div class="dashboard-state" *ngIf="loading">
      <mat-progress-spinner diameter="40" mode="indeterminate"></mat-progress-spinner>
      <p>Loading dashboard...</p>
    </div>
    <div class="dashboard-state error" *ngIf="!loading && error">
      <mat-icon color="warn">error_outline</mat-icon>
      <p>{{ error }}</p>
      <button mat-flat-button color="primary" (click)="loadDashboardData()">Retry</button>
    </div>
  </ng-template>

  <ng-template #emptyState>
    <div class="dashboard-state">
      <mat-icon>dashboard</mat-icon>
      <p>No dashboard data yet. Add tasks to populate these insights.</p>
    </div>
  </ng-template>

  <ng-template #noUpcoming>
    <div class="empty-widget">No upcoming tasks.</div>
  </ng-template>

  <ng-template #noTrend>
    <div class="empty-widget">No activity recorded for this period.</div>
  </ng-template>
</div>